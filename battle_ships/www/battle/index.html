{% extends 'templates/base.html'%}

{% block navbar %}{% endblock %}
{% block content%}
<main class="w-100 h-100">
    <div class="game-title-bar mb-1 d-flex justify-content-center">
        <h1 class="title m-x mt-4">{{ _("Battle Ships") }}</h1>
    </div>
    <hr class="m-0">
    <div class="d-flex justify-content-center mt-20">
        <div>
            <div class="game-board container">
        
            </div>
        </div>
    </div>
</main>
<script>

    let shipImageUrl = "https://cdn-icons.flaticon.com/png/512/870/premium/870170.png?token=exp=1643200075~hmac=11089a6c8c40dc6d9b132b5b9fdca329"
    let attackImageUrl = "https://cdn-icons-png.flaticon.com/512/1828/1828665.png"

    let maxRows = 5;
    let maxColumns = 5;

    let maxShips = 3;
    let maxAttacks = 3;

    let shipsPlaced = 0;
    let attacksPlaced = 0;

    let gameBoard;

    let fetchSessionPlayerId = getSessionPlayerId;

    frappe.ready(function() {
        gameBoard = $(".game-board");
        
        loadBoard();
        boardInterationHandler();

        fetchSessionPlayerId().then((playerId) => {
            console.log(playerId);
        });
    });

    function loadBoard() {

        for(var i = 0; i < maxRows; i++) {
            let row = $("<div class='row'>");
            for(var j = 0; j < maxColumns; j++) {
                let rowItem = $(`
                    <div class="board-row-item row-item frappe-card m-1" style="height: 50px; width: 50px"></div>
                `);
                rowItem.attr('row', i);
                rowItem.attr('col', j);
                rowItem.attr('item', 'Blank')
                row.append(rowItem);
            }
            gameBoard.append(row);
        }
    }

    function boardInterationHandler() {
        $(".board-row-item").click(function() {
            let rowIndex = $(this).attr('row');
            let colIndex = $(this).attr('col');

            let curItem = $(this).attr('item');

            if (curItem == 'Blank') {
                if (shipsPlaced < maxShips) {
                    placeItem(this, 'Ship');
                } else {
                    curItem = 'Ship';
                }
            }
            if (curItem == 'Ship') {
                if(attacksPlaced < maxAttacks) {
                    placeItem(this, 'Attack');
                } else {
                    curItem = 'Attack';
                }
            }
            if (curItem == 'Attack') {
                placeItem(this, 'Blank');
            }
        });
    }

    function placeItem(holder, itemName) {
        let prevItem = $(holder).attr('item');

        $(holder).empty();
        $(holder).attr('item', itemName)
        if (['Attack', 'Ship'].includes(itemName)) {
            $(holder).append($(`<img src=${itemName == 'Attack' ? attackImageUrl : shipImageUrl}>`))
            itemName == 'Attack' ? attacksPlaced++ : shipsPlaced++;
        }

        if (prevItem == 'Attack') {
            attacksPlaced--;
        } else if(prevItem == 'Ship') {
            shipsPlaced--;
        }

        if (attacksPlaced == maxAttacks && shipsPlaced == maxShips) {
            uploadResult();
        }
    }

    async function uploadResult() {
        frappe.call({
            method: 'battle_ships.www.battle.index.upload_result',
            args: {
                player_id: await getSessionPlayerId(),
                result: getItems()
            },
            callback: function() {
                console.log('result uploaded');
            }
        })
    }

    function getItems() {
        let shipElements = gameBoard.find(`[item='Ship']`);
        let attackElements = gameBoard.find(`[item='Attack'`);

        let ships = [];
        let attacks = [];

        for (var i = 0; i < shipElements.length; i++) {

            let row = parseInt($(shipElements[i]).attr('row'));
            let col = parseInt($(shipElements[i]).attr('col'));

            ships.push([row, col]);
        }

        for (var i = 0; i < attackElements.length; i++) {
            let row = parseInt($(attackElements[i]).attr('row'));
            let col = parseInt($(attackElements[i]).attr('col'));

            attacks.push([row, col]);
        }

        return {
            ships: ships,
            attacks: attacks
        }
    }

    async function getSessionPlayerId() {
        let playerId = '';
        if (localStorage['sessionPlayerId']) {
            playerId = localStorage['sessionPlayerId'];
        } else {
            await frappe.call({
                method: 'battle_ships.www.battle.index.create_session_player',
                callback: function(r) {
                    localStorage['sessionPlayerId'] = r.message;
                    playerId = r.message;
                }
            })
        }
        return playerId
    }

</script>
<style>
    .title {
        color: rgb(223, 223, 223)
    }
    .board-row-item {
        background-color:rgb(58, 58, 58);
    }
    body {
        background-color: rgb(0, 0, 0);
    }
</style>
{% endblock %}
{% block footer %}{% endblock %}